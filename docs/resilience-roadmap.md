# 系统健壮性与稳定性规划（落地方案）

## 目标与基线
- 可用性：核心 API ≥ 99.9%
- 延迟：读 P95 ≤ 200ms；任务触发→入库 ≤ 1s
- 告警时效：≤ 30s；拥塞降级不丢
- 数据一致性：统计延迟一致性 ≤ 60s

## 分层边界
- 路由层（api/routes）/ 服务层（api/services）/ 中间件（api/middleware）/ 迁移脚本（api/scripts）
- 数据：Postgres（demo1 模式）与迁移脚本统一
- 调度器：单点运行 + 互斥（后续主选举）
- 权限：按 system_id 隔离管理

## 第一阶段（立即落地）
1. 统一错误处理中间件 + 请求校验（zod）
2. 指标端点 `/api/metrics`（Prometheus 文本）：DB 延迟/调度器状态/近24h 成功失败计数/进程内存
3. 结构化日志（JSON 简版）与请求 ID 注入（最低可行）
4. 任务状态机与重试策略（表字段：`max_retries`、`retry_backoff_seconds`；失败后定时重试）

## 第二阶段（弹性与告警）
- 分布式锁/主选举，避免重复调度
- 告警评估器独立，发送限流与去重，复合规则

## 第三阶段（对外服务）
- `/api/v1/ext/*` 权限/告警/心跳入口；API Key + 签名校验

## 第四阶段（可观测与恢复）
- 服务器心跳与故障处理；备份与恢复演练；Grafana 大盘

## 验收标准（每项）
- 有代码变更、可访问端点、手动或脚本验证通过；不影响现有功能

